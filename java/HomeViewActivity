package com.project.innerpeace

import android.content.Intent
import android.os.Bundle
import android.util.Log
import android.view.Menu
import android.view.MenuItem
import androidx.appcompat.app.AppCompatActivity
import com.naver.maps.map.LocationTrackingMode
import com.naver.maps.map.MapFragment
import com.naver.maps.map.NaverMap
import com.naver.maps.map.OnMapReadyCallback
import com.naver.maps.map.util.FusedLocationSource
import kotlinx.android.synthetic.main.activity_home_view.*


class HomeViewActivity : AppCompatActivity(), OnMapReadyCallback {
    private lateinit var locationSource: FusedLocationSource
    private lateinit var naverMap: NaverMap

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        //뷰 set
        setContentView(R.layout.activity_home_view)
        setSupportActionBar(findViewById(R.id.my_toolbar))

        //ToolBar
        supportActionBar?.setDisplayHomeAsUpEnabled(true)
        supportActionBar?.setHomeButtonEnabled(true)
        supportActionBar?.setDisplayShowTitleEnabled(false)

        //네이버 지도 객체 불러오기
        val fm = supportFragmentManager
        val mapFragment = fm.findFragmentById(R.id.map_fragment) as MapFragment?
            ?: MapFragment.newInstance().also {
                fm.beginTransaction().add(R.id.map_fragment, it).commit()
            }
        mapFragment.getMapAsync(this)

        //현재위치 가져오기
        locationSource =
            FusedLocationSource(this, LOCATION_PERMISSION_REQUEST_CODE)
        
        allToilet.setOnClickListener {
            startActivity(Intent(this@HomeViewActivity, A_All_view::class.java))
        }
        metroToilet.setOnClickListener {
            startActivity(Intent(this@HomeViewActivity, B_Sub_view::class.java))
        }
        cafeToilet.setOnClickListener {
            startActivity(Intent(this@HomeViewActivity, E_Cafe_view::class.java))
        }
        restaurantToilet.setOnClickListener {
            startActivity(Intent(this@HomeViewActivity, D_Food_view::class.java))
        }
        BarToilet.setOnClickListener {
            startActivity(Intent(this@HomeViewActivity, F_Beer_view::class.java))
        }
        MarketToilet.setOnClickListener {
            startActivity(Intent(this@HomeViewActivity, C_Mart_view::class.java))
        }
    }


    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array<out String>,
        grantResults: IntArray
    ) {
        if (locationSource.onRequestPermissionsResult(
                requestCode, permissions,
                grantResults
            )
        ) {

            if (!locationSource.isActivated) { // 권한 거부됨
                naverMap.locationTrackingMode = LocationTrackingMode.None
//                Log.d("map_permit","권한 거부됨")
            }
            return
        }
        super.onRequestPermissionsResult(requestCode, permissions, grantResults)
    }

    override fun onMapReady(naverMap: NaverMap) {
        this.naverMap = naverMap
        var locationOverlay = naverMap.locationOverlay
        locationOverlay.isVisible = true    //오버레이 보이게 하기
        naverMap.locationSource = locationSource
        naverMap.locationTrackingMode = LocationTrackingMode.Follow     //현재위치 추적모드
//        Log.d("map_permit","권한 허가됨")
    }

    companion object {
        private const val LOCATION_PERMISSION_REQUEST_CODE = 1000
    }


    //ToolBar
    override fun onOptionsItemSelected(item: MenuItem): Boolean {
        val id = item.itemId
        when (id) {
            android.R.id.home -> {
                finish()
                return true
            }
        }
        return super.onOptionsItemSelected(item)
    }

    override fun onCreateOptionsMenu(menu: Menu): Boolean {
        val inflater = menuInflater
        inflater.inflate(R.menu.menu, menu)
        return true
    }


}



